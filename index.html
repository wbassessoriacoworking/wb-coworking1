<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WB Coworking - App</title>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        :root {
            --primary: #004aad; /* Azul WB */
            --bg: #f8f9fa;
            --white: #ffffff;
            --text: #333;
        }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); }
        
        /* Container estilo Celular */
        .app-container { max-width: 480px; margin: 0 auto; background: var(--white); min-height: 100vh; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        
        /* Cabe√ßalho */
        header { background: var(--primary); color: white; padding: 20px; text-align: center; font-weight: bold; font-size: 1.2rem; }
        
        /* Telas */
        .screen { padding: 20px; display: none; flex-grow: 1; animation: fadeIn 0.4s; }
        .screen.active { display: block; }

        /* Bot√µes e Inputs */
        input { width: 100%; padding: 12px; margin: 8px 0 15px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        label { font-weight: bold; font-size: 0.9rem; color: #555; }
        
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; margin-top: 10px; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-danger { background: #ff4d4d; color: white; }

        /* Grid de Hor√°rios */
        .slots { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .slot { background: #eee; padding: 10px; text-align: center; border-radius: 5px; cursor: pointer; }
        .slot.selected { background: var(--primary); color: white; border: 1px solid var(--primary); }

        /* Cards de Agendamento */
        .card { background: #f1f1f1; padding: 15px; border-radius: 8px; border-left: 5px solid var(--primary); margin-bottom: 10px; }

        .hidden { display: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="app-container">

    <div id="screen-login" class="screen active">
        <div style="text-align: center; margin-top: 40px; margin-bottom: 40px;">
            <h1 style="color: var(--primary); margin:0;">WB Coworking</h1>
            <p style="color: #777;">Fa√ßa login para reservar</p>
        </div>
        
        <label>E-mail</label>
        <input type="email" id="loginEmail" placeholder="seu@email.com">
        
        <label>Senha</label>
        <input type="password" id="loginPass" placeholder="******">
        
        <button class="btn btn-primary" onclick="doLogin()">Entrar</button>
    </div>

    <div id="screen-home" class="screen">
        <header style="margin: -20px -20px 20px -20px; border-radius: 0 0 15px 15px;">
            Ol√°, <span id="userNameDisplay">Usu√°rio</span> üëã
        </header>

        <button class="btn btn-primary" onclick="goTo('screen-booking')">üìÖ Nova Reserva</button>
        <button class="btn btn-outline" onclick="goTo('screen-my-appointments')">üìÇ Meus Agendamentos</button>
        <button class="btn btn-outline" onclick="goTo('screen-support')">üí¨ Suporte</button>
        
        <div style="margin-top: 40px;">
            <button class="btn btn-danger" onclick="doLogout()">Sair</button>
        </div>
    </div>

    <div id="screen-booking" class="screen">
        <h3 style="color: var(--primary); text-align: center;">Nova Reserva</h3>
        
        <label>1. Escolha a Data</label>
        <input type="date" id="dateInput">

        <div id="timeSection" class="hidden">
            <label>2. Escolha o Hor√°rio</label>
            <div class="slots" id="slotsContainer"></div>
        </div>

        <div id="formSection" class="hidden">
            <hr style="border: 0; border-top: 1px solid #ddd; margin: 20px 0;">
            <label>3. Seus Dados</label>
            
            <input type="text" id="bookingName" placeholder="Nome Completo">
            <input type="tel" id="bookingPhone" placeholder="WhatsApp (11) 99999-9999">
            
            <div id="payment-brick_container"></div>
        </div>

        <button class="btn btn-outline" onclick="goTo('screen-home')" style="margin-top: 20px;">‚¨Ö Voltar</button>
    </div>

    <div id="screen-my-appointments" class="screen">
        <h3 style="color: var(--primary); text-align: center;">Meus Agendamentos</h3>
        <div id="appointmentsList">
            </div>
        <button class="btn btn-outline" onclick="goTo('screen-home')" style="margin-top: 20px;">‚¨Ö Voltar</button>
    </div>

    <div id="screen-support" class="screen">
        <h3 style="color: var(--primary); text-align: center;">Suporte</h3>
        <div class="card">
            <p><strong>WB Assessoria</strong></p>
            <p>üìç Penha, S√£o Paulo</p>
            <p>üìû (11) 99999-9999</p>
            <p>‚úâÔ∏è contato@wbcoworking.com.br</p>
        </div>
        <button class="btn btn-outline" onclick="goTo('screen-home')">‚¨Ö Voltar</button>
    </div>

</div>

<script>
    // --- SUAS CHAVES (J√Å CONFIGURADAS) ---
    const MP_PUBLIC_KEY = 'APP_USR-4509a478-fbe8-424c-ba34-f0de01106417'; 
    const WEBHOOK_URL = 'https://hook.us2.make.com/91xnrodd2h29jo8jm89jpy926f092u5g'; 

    // --- VARI√ÅVEIS DO SISTEMA ---
    let selectedDate = null;
    let selectedTime = null;
    let mp = null;
    let bricksBuilder = null;

    // --- NAVEGA√á√ÉO ENTRE TELAS ---
    function goTo(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
        if(screenId === 'screen-my-appointments') loadAppointments();
    }

    // --- SISTEMA DE LOGIN (Simples) ---
    function doLogin() {
        const email = document.getElementById('loginEmail').value;
        if(email.includes('@')) {
            localStorage.setItem('userEmail', email);
            document.getElementById('userNameDisplay').innerText = email.split('@')[0];
            goTo('screen-home');
        } else {
            alert("Por favor, digite um e-mail v√°lido.");
        }
    }

    function doLogout() {
        localStorage.removeItem('userEmail');
        location.reload();
    }

    // --- INICIALIZA√á√ÉO MERCADO PAGO ---
    try {
        mp = new MercadoPago(MP_PUBLIC_KEY, { locale: 'pt-BR' });
        bricksBuilder = mp.bricks();
    } catch (e) { console.error("Erro MP:", e); }

    // --- L√ìGICA DE AGENDAMENTO ---
    const dateInput = document.getElementById('dateInput');
    const timeSection = document.getElementById('timeSection');
    const slotsContainer = document.getElementById('slotsContainer');
    const formSection = document.getElementById('formSection');

    dateInput.addEventListener('change', (e) => {
        selectedDate = e.target.value;
        if(selectedDate) {
            timeSection.classList.remove('hidden');
            formSection.classList.add('hidden');
            generateSlots();
        }
    });

    function generateSlots() {
        slotsContainer.innerHTML = '';
        for(let i=9; i<18; i++) {
            const time = `${i < 10 ? '0'+i : i}:00`;
            const div = document.createElement('div');
            div.className = 'slot';
            div.innerText = time;
            div.onclick = () => selectTime(time, div);
            slotsContainer.appendChild(div);
        }
    }

    function selectTime(time, el) {
        document.querySelectorAll('.slot').forEach(s => s.classList.remove('selected'));
        el.classList.add('selected');
        selectedTime = time;
        formSection.classList.remove('hidden');
        renderBrick();
    }

    async function renderBrick() {
        document.getElementById('payment-brick_container').innerHTML = '';
        if(!bricksBuilder) return;

        const settings = {
            initialization: { amount: 50.00 },
            customization: { paymentMethods: { ticket: "all", bankTransfer: "all", creditCard: "all", debitCard: "all" } },
            callbacks: {
                onSubmit: ({ selectedPaymentMethod, formData }) => {
                    return new Promise((resolve, reject) => {
                        const name = document.getElementById('bookingName').value;
                        const phone = document.getElementById('bookingPhone').value;
                        const email = localStorage.getItem('userEmail');

                        if(!name || !phone) { alert("Preencha todos os campos!"); reject(); return; }

                        sendToMake(name, phone, email).then(() => {
                            resolve();
                        }).catch(reject);
                    });
                },
                onError: (error) => console.error(error)
            }
        };
        window.paymentBrickController = await bricksBuilder.create("payment", "payment-brick_container", settings);
    }

    // --- ENVIO PARA O MAKE (COM AS CORRE√á√ïES V23) ---
    async function sendToMake(name, phone, email) {
        
        // 1. Calcular Data/Hora final
        const [h, m] = selectedTime.split(':').map(Number);
        let endH = h + 1;
        const endTime = `${endH < 10 ? '0'+endH : endH}:${m < 10 ? '0'+m : m}`;

        // 2. Formatar para Google Calendar (ISO 8601)
        const googleStart = `${selectedDate}T${selectedTime}:00`;
        const googleEnd   = `${selectedDate}T${endTime}:00`;

        // 3. Limpar telefone
        const cleanPhone = phone.replace(/\D/g, '');

        const payload = {
            userName: name,
            userPhone: cleanPhone,
            userEmail: email,
            date: selectedDate,
            time: selectedTime,
            googleStart: googleStart, // ESSENCIAL
            googleEnd: googleEnd,     // ESSENCIAL
            status: "approved"
        };

        try {
            await fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            // Salva localmente para exibir na tela "Meus Agendamentos"
            saveBookingLocal(selectedDate, selectedTime, name);

            alert("‚úÖ Pagamento e Reserva Confirmados!");
            goTo('screen-my-appointments');

        } catch (error) {
            console.error(error);
            alert("Reserva registrada com sucesso (aviso de rede).");
        }
    }

    // --- FUN√á√ïES EXTRAS (BANCO DE DADOS LOCAL) ---
    function saveBookingLocal(date, time, name) {
        const bookings = JSON.parse(localStorage.getItem('wbBookings') || '[]');
        bookings.push({ date, time, name });
        localStorage.setItem('wbBookings', JSON.stringify(bookings));
    }

    function loadAppointments() {
        const list = document.getElementById('appointmentsList');
        const bookings = JSON.parse(localStorage.getItem('wbBookings') || '[]');
        
        if(bookings.length === 0) {
            list.innerHTML = '<p style="text-align:center; color:#888;">Nenhum agendamento ainda.</p>';
            return;
        }

        list.innerHTML = '';
        bookings.reverse().forEach(b => {
            const datePt = b.date.split('-').reverse().join('/');
            list.innerHTML += `
                <div class="card">
                    <strong style="color:var(--primary)">${datePt} √†s ${b.time}</strong><br>
                    <span>${b.name}</span><br>
                    <small>Status: Confirmado ‚úÖ</small>
                </div>
            `;
        });
    }

</script>

</body>
</html>
